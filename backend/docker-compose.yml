version: '3.8'

services:

  ### MySQL Database
  mysql:

    ### Using MySQL 8.0 official image 
    image: mysql:8.0
    container_name: auction-mysql

    ### MySQL Configuration 
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword  # Sets the root password
      MYSQL_DATABASE: auction_system     # Creates the database on startup with the given name
      MYSQL_USER: auction_user           # Creates a user with the given name
      MYSQL_PASSWORD: auction_password   # Sets the password for the above user

    ### Port mapping to expose MySQL on the host machine (default MySQL port 3306)
    # since communication with mysql is internal to the docker network there is no need to
    # expose it to the host machine, but it can be useful for debugging (e.g. connecting 
    # with a MySQL client from the host to troubleshoot issues)
    ports:
      - "13306:3306"
    
    ### Volumes for data persistence and initialization script
    # The mysql_data volume will persist the database data across container restarts, to 
    # remove it simply delete the volume
    # The init.sql file is mounted to initialize the database schema and seed data on 
    # first run, if you need to change the schema, modify init.sql, delete the volume, and
    # restart the container (if you don't delete the volume the init script will not run again)
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

    ### Healthcheck to ensure MySQL is ready before the backend tries to connect
    # This uses the mysqladmin ping command to check if the server is up
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  ### Erlang Master Node (POST endpoints)
  erlang-master:

    ### Build configuration for the Erlang service
    build:
      context: ../src/erlang
      dockerfile: Dockerfile
    container_name: auction-erlang-master
    hostname: erlang-master
    
    ### Port mapping to expose the Erlang POST API on port 8081
    ports:
      - "8081:8081"
    
    ### Environment to configure as master
    environment:
      NODE_NAME: auction
      NODE_ROLE: master
      HTTP_PORT: 8081
    
    volumes:
      - erlang_master_data:/app/Mnesia.auction@erlang-master
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    
    restart: unless-stopped

  ### Erlang Slave Node 1 (WebSocket)
  erlang-slave1:

    build:
      context: ../src/erlang
      dockerfile: Dockerfile
    container_name: auction-erlang-slave1
    hostname: erlang-slave1
    
    ### Port mapping for WebSocket on port 8082
    ports:
      - "8082:8082"
    
    environment:
      NODE_NAME: auction_slave1
      NODE_ROLE: slave
      HTTP_PORT: 8082
      MASTER_NODE: auction@erlang-master
    
    depends_on:
      erlang-master:
        condition: service_healthy
    
    restart: unless-stopped

  ### Erlang Slave Node 2 (WebSocket)
  erlang-slave2:

    build:
      context: ../src/erlang
      dockerfile: Dockerfile
    container_name: auction-erlang-slave2
    hostname: erlang-slave2
    
    ### Port mapping for WebSocket on port 8083
    ports:
      - "8083:8083"
    
    environment:
      NODE_NAME: auction_slave2
      NODE_ROLE: slave
      HTTP_PORT: 8083
      MASTER_NODE: auction@erlang-master
    
    depends_on:
      erlang-master:
        condition: service_healthy
    
    restart: unless-stopped

  ### Java Backend
  backend:

    ### Build configuration for the backend service
    # Fetches the Dockerfile in the current directory to build the image
    build:
      context: .
      dockerfile: Dockerfile
    container_name: auction-backend
    
    ### Port mapping to expose the backend service on port 8080
    ports:
      - "8080:8080"
    

    extra_hosts:
      - "host.docker.internal:host-gateway"

    
    ### Environment variables for database connection
    # These should match the MySQL service configuration and will be used by the backend 
    # to connect to the database 
    environment:
      DB_URL: jdbc:mysql://mysql:3306/auction_system
      DB_USER: auction_user
      DB_PASSWORD: auction_password
      JWT_SECRET: DSMT_PROJECT_SECRETKEY_MINIMUM_48_BYTES_FOR_HS384 # Secret key for JWT signing (must be >= 48 bytes for HS384)

    ### Service dependencies
    # Ensures that the backend service starts only after the MySQL service is healthy (i.e. 
    # container is running and MySQL is answering pings)
    depends_on:
      mysql:
        condition: service_healthy

### Define named volumes for data persistence
volumes:
  mysql_data: # Persists MySQL data across container restarts
  erlang_master_data: # Persists Erlang master Mnesia data
